<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | minqx</title>
    <link rel="shortcut icon" href="./static/TemplateData/favicon.ico">
    <link rel="stylesheet" href="./static/TemplateData/style.css">
    
    <!-- سياسة أمان المحتوى المعدلة مع مصادر إضافية -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self' data: gap: https://ssl.gstatic.com;
      script-src 'self' https://cdn.jsdelivr.net https://unpkg.com https://cdn.tonconnect.dev 'unsafe-eval' 'unsafe-inline';
      style-src 'self' 'unsafe-inline';
      img-src 'self' data: https://via.placeholder.com;
      connect-src 'self' https://*;
      frame-src 'self' https://*;
    ">
    
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
  </head>
  <body>
    <!-- عناصر الواجهة -->
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width="1080" height="1920"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"></div>
      <div id="unity-footer">
        <div id="unity-webgl-logo"></div>
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">minqx</div>
      </div>
    </div>

    <div class="user-info">
      <img id="user-photo" src="" alt="User Photo" width="100" height="100">
      <h2 id="user-name"></h2>
    </div>

    <script>
      // ========== نظام تحميل المكتبات المحسن ==========
      const LibraryManager = {
        // مصادر متعددة لـ TonConnect SDK مع الأولوية للنسخة المحلية
        TONCONNECT_SOURCES: [
          './static/libs/tonconnect-sdk.min.js', // النسخة المحلية أولاً
          'https://cdn.tonconnect.dev/tonconnect-sdk/tonconnect-sdk.min.js',
          'https://unpkg.com/@tonconnect/sdk@2.1.1/dist/tonconnect-sdk.min.js'
        ],
        
        // دالة محسنة لتحميل المكتبات مع التحقق من التحميل
        loadLibrary: async function(sources, libraryName) {
          let lastError = null;
          
          for (const source of sources) {
            try {
              await this.loadScript(source);
              
              // التحقق من أن المكتبة فعلاً محملة في window
              if (window.TonConnect) {
                console.log(`تم تحميل ${libraryName} بنجاح من: ${source}`);
                return true;
              }
              throw new Error(`تم تحميل الملف ولكن ${libraryName} غير معرّف`);
              
            } catch (error) {
              console.warn(`فشل تحميل ${libraryName} من ${source}:`, error.message);
              lastError = error;
              continue;
            }
          }
          
          throw new Error(`فشل تحميل ${libraryName} من جميع المصادر. آخر خطأ: ${lastError?.message}`);
        },
        
        // دالة أساسية لتحميل السكريبتات
        loadScript: function(src) {
          return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            
            script.onload = resolve;
            script.onerror = () => reject(new Error(`فشل تحميل السكريبت من ${src}`));
            
            document.body.appendChild(script);
          });
        }
      };

      // ========== نظام إدارة التطبيق ==========
      const App = {
        unityInstance: null,
        connector: null,
        
        init: async function() {
          try {
            console.log('بدء تهيئة التطبيق...');
            
            // 1. تحميل TonConnect SDK مع نظام متعدد المصادر
            await LibraryManager.loadLibrary(
              LibraryManager.TONCONNECT_SOURCES,
              'TonConnect SDK'
            );
            
            // 2. تهيئة TonConnect مع التحقق الإضافي
            await this.initializeTonConnect();
            
            // 3. تحميل وتشغيل Unity
            await this.setupUnity();
            
            // 4. تحميل بيانات المستخدم
            this.loadUserProfile();
            
            // 5. تفعيل الوظائف لـ Unity
            this.setupUnityBridge();
            
            console.log('تم تهيئة التطبيق بنجاح');
            
          } catch (error) {
            console.error('فشل تهيئة التطبيق:', error);
            this.showError('حدث خطأ أثناء تحميل التطبيق. يرجى تحديث الصفحة.');
          }
        },
        
        // ========== تهيئة TonConnect المحسنة ==========
        initializeTonConnect: async function() {
          try {
            // تحقق نهائي من وجود المكتبة
            if (typeof TonConnect === 'undefined') {
              throw new Error('مكتبة TonConnect غير متاحة');
            }
            
            console.log('جاري تهيئة TonConnect...');
            this.connector = new TonConnect.TonConnect({
              manifestUrl: 'https://yourdomain.com/tonconnect-manifest.json'
            });
            
            // محاولة استعادة الاتصال السابق
            try {
              const walletConnectionSource = { jsBridgeKey: 'tonconnect' };
              await this.connector.restoreConnection(walletConnectionSource);
              console.log('تم استعادة الاتصال السابق (إن وجد)');
            } catch (restoreError) {
              console.warn('لا يمكن استعادة الاتصال السابق:', restoreError);
            }
            
          } catch (error) {
            console.error('فشل تهيئة TonConnect:', error);
            throw error;
          }
        },
        
        // ... [بقية الدوال كما هي مع التأكد من استخدام await حيثما يلزم] ...
        // setupUnity, loadUserProfile, loadImageWithFallback, etc...
        
        // ========== جسر الاتصال مع Unity ==========
        setupUnityBridge: function() {
          window.TON = {
            connectWallet: () => {
              if (!this.connector) {
                this.showError('خدمة المحفظة غير جاهزة');
                return;
              }
              this.connectTONWallet();
            },
            disconnectWallet: () => this.disconnectTONWallet(),
            getBalance: async (address) => await this.getWalletBalance(address),
            isReady: () => this.connector !== null && this.unityInstance !== null
          };
        },
        
        // ... [وظائف المحفظة كما هي] ...
      };
      
      // تكييف الواجهة للجوال
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        const meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.head.appendChild(meta);
        document.querySelector("#unity-container").className = "unity-mobile";
        document.querySelector("#unity-canvas").className = "unity-mobile";
      }
      
      // بدء التطبيق عند اكتمال تحميل الصفحة
      document.addEventListener('DOMContentLoaded', () => {
        console.log('صفحة الويب جاهزة، بدء التطبيق...');
        App.init();
      });
    </script>
  </body>
</html>
